<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FLPY ‚Äî Game Over</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{ --bg:#0b1220; --fg:#e9eefb; --accent:#ffd028; --muted:#93a2c8; }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; background:radial-gradient(1200px 600px at 70% -10%, #1a2140 0%, #0b1220 46%, #070b16 100%); color:var(--fg); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .wrap{ min-height:100%; display:grid; grid-template-rows:1fr auto; }
    header{ padding:22px 28px; display:flex; justify-content:space-between; align-items:center; }
    header a{ color:var(--fg); text-decoration:none; font-weight:700; }
    main{ display:grid; place-items:center; padding:30px 16px; text-align:center; }
    .card{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:28px 22px; width:min(720px,92vw); box-shadow:0 12px 30px rgba(0,0,0,.35); }
    .title{ font-size:34px; margin-bottom:8px; }
    .score{ font-size:22px; color:var(--muted); margin-bottom:18px; }
    .big{ font-size:48px; font-weight:800; color:#fff; letter-spacing:.5px; }
    .hs{ margin-top:8px; font-size:16px; color:#cfd7f3; }
    .actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:24px; }
    .btn{ appearance:none; border:none; cursor:pointer; padding:14px 24px; border-radius:12px; font-weight:800; text-decoration:none; transition:transform .08s ease, box-shadow .2s ease; }
    .btn-primary{ background:var(--accent); color:#2a2100; box-shadow:0 8px 24px rgba(255,208,40,.35); }
    .btn-primary:hover{ transform:translateY(-2px); }
    .btn-ghost{ background:rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.25); }
    footer{ text-align:center; color:#95a3cf; font-size:13px; padding:18px; }
    img.logo{ width:64px; height:64px; image-rendering:pixelated; margin-bottom:8px; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="./index.html">‚Üê FLPY</a>
    <a href="https://t.me/flpycommunity" target="_blank" rel="noopener">Telegram</a>
  </header>

  <main>
    <div class="card">
      <img class="logo" src="./flpy.png" alt="FLPY logo">
      <div class="title">Game Over</div>
      <div class="score">Your score</div>
      <div class="big" id="final-score">0</div>
      <div class="hs">High Score: <b id="high-score">‚Äî</b></div>

      <div class="actions">
        <a class="btn btn-ghost" href="./index.html">üè† Accueil</a>
        <a id="btn-again" class="btn btn-primary" href="./game.html">‚ü≥ Recommencer</a>
      </div>

      <!-- üéâ WORLD RECORD REWARD -->
      <div id="wr-reward" style="display:none; margin-top:16px; padding:14px 14px;
        border:1px solid rgba(255,255,255,.18); border-radius:12px; background:rgba(255,208,40,.10);">
        <div style="font-weight:800; font-size:18px; margin-bottom:6px;">üéâ New WORLD RECORD!</div>
        <div style="font-size:15px; line-height:1.5;">
          You earned <b id="wr-amount">‚Äî</b> FLPY (<span id="wr-delta">Œî +0</span>).
          <span id="wr-note" style="color:#d8def7"></span>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
          <button id="btn-claim" class="btn btn-primary">üí∞ Claim on Telegram</button>
          <button id="btn-copy" class="btn btn-ghost">üìã Copy claim text</button>
        </div>
      </div>
    </div>
  </main>

  <footer>¬© FLPY ‚Äî play responsibly</footer>
</div>

<!-- Score handling + local storage -->
<script>
(function(){
  const params = new URLSearchParams(window.location.search);
  const score = Number(params.get('score') || 0);

  const elFinal = document.getElementById('final-score');
  elFinal.textContent = String(score);

  const prev = Number(localStorage.getItem('flpy_highscore') || 0);
  if (score > prev) localStorage.setItem('flpy_highscore', String(score));
  const hs = Number(localStorage.getItem('flpy_highscore') || 0);
  document.getElementById('high-score').textContent = String(hs);

  if (!params.has('score')) {
    // window.location.replace('./game.html');
  }

  document.getElementById('btn-again')?.addEventListener('click', (e)=>{
    // Par d√©faut le lien suffit.
  });
})();
</script>

<!-- Envoi du score vers Supabase -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPABASE_URL = "https://hnfmoxeomazaqenuqjsj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuZm1veGVvbWF6YXFlbnVxanNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjcwMDQsImV4cCI6MjA3NTgwMzAwNH0.-u1OuGPpHo-DqBWWmRTURth8MQnLJZ5AAqoGC-EuPRI";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

(async function pushScore(){
  const params = new URLSearchParams(location.search);
  const score = Number(params.get('score') || 0);
  if (!score) return;
  const wallet = localStorage.getItem('flpy_wallet') || null;
  try {
    await supabase.from('scores').insert({ wallet, score });
  } catch (e) {
    console.warn('Insert score failed', e);
  }
})();
</script>

<!-- üü° D√©tection du World Record + Reward System -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://hnfmoxeomazaqenuqjsj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuZm1veGVvbWF6YXFlbnVxanNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjcwMDQsImV4cCI6MjA3NTgwMzAwNH0.-u1OuGPpHo-DqBWWmRTURth8MQnLJZ5AAqoGC-EuPRI";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const TELEGRAM_GROUP_URL = "https://t.me/+hZGqh1DHN6w1MWE8";

// Bar√®me de r√©compense
function payoutForDelta(delta) {
  if (delta >= 21) return 20000;
  if (delta >= 11) return 10000;
  if (delta >= 6)  return 5000;
  if (delta >= 3)  return 2500;
  if (delta >= 0)  return 1000;
  return 0;
}

async function detectWRAndShow() {
  const params = new URLSearchParams(location.search);
  const finalScore = Number(params.get("score") || 0);
  if (!finalScore) return;

  const { data: evts, error } = await supabase
    .from("events")
    .select("wallet, score, created_at")
    .eq("type", "WORLD_RECORD")
    .order("created_at", { ascending: false })
    .limit(2);

  if (error || !evts?.length) return;
  const latest = evts[0];
  const prev = evts[1] || { score: 0 };

  const isThisRunWR = (latest.score === finalScore);
  if (!isThisRunWR) return;

  const delta = Math.max(0, latest.score - prev.score);
  const reward = payoutForDelta(delta);
  if (reward <= 0) return;

  const wallet = localStorage.getItem("flpy_wallet") || "guest";
  const $wrap   = document.getElementById("wr-reward");
  const $amount = document.getElementById("wr-amount");
  const $delta  = document.getElementById("wr-delta");
  const $note   = document.getElementById("wr-note");
  const $claim  = document.getElementById("btn-claim");
  const $copy   = document.getElementById("btn-copy");

  $amount.textContent = reward.toLocaleString();
  $delta.textContent  = `Œî +${delta}`;
  $note.textContent   = wallet === "guest"
    ? " (tip: connect a wallet next time to link rewards)"
    : ` ¬∑ Wallet: ${wallet.slice(0,4)}‚Ä¶${wallet.slice(-4)}`;

  const claimText = `WR Claim ‚Äî FLPY
Score: ${finalScore} (Œî +${delta})
Reward: ${reward} FLPY
Wallet: ${wallet}
Timestamp: ${new Date().toISOString()}
Please verify and send.`;

  async function copyClaim() {
    try {
      await navigator.clipboard.writeText(claimText);
      alert("Claim text copied. Paste it in Telegram.");
    } catch {
      prompt("Copy this claim text:", claimText);
    }
  }

  $claim.addEventListener("click", async () => {
    await copyClaim();
    window.open(TELEGRAM_GROUP_URL, "_blank", "noopener");
  });
  $copy.addEventListener("click", copyClaim);

  $wrap.style.display = "block";
}

detectWRAndShow();
</script>
</body>
</html>
